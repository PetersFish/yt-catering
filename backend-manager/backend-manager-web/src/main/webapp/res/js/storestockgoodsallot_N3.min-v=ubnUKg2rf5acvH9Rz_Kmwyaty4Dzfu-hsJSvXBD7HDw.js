$(document).ready(function(){transfer.getRecordsPage("","","","","");transfer.operating();addTransfer.openTransferPage();$("#Statetype").val()=="0"&&$("#OutStore").attr("disabled","disabled")});var pageSize=15,checkedProductId={},zeroStockProductObject={},transfer={getRecordsPage:function(n,t,i,r,u){var f={aupplyshop_id:n,targetshop_id:t,search:i,startDate:r,endDate:u,pageSize:pageSize};f=JSON.stringify(f);$.get("/StoreStockGoodsAllot/GetTransfersRecordList/",{searchconditions:f,pageIndex:0},function(n){var t=0,i;n!=null&&n.sumnumber!=null&&(t=n.sumnumber);i=Math.ceil(t/pageSize);laypage({cont:$("#pageGro"),pages:i,skin:"molv",skip:!0,first:"\u9996\u9875",last:"\u5c3e\u9875",prev:"\u4e0a\u4e00\u9875",next:"\u4e0b\u4e00\u9875",jump:function(n){transfer.getRecordsList(f,n.curr)}})})},getRecordsList:function(n,t){$.getJson("/StoreStockGoodsAllot/GetTransfersRecordList/",{searchconditions:n,pageIndex:t},function(n){var i,t;if(n!=null&&n.list!=null){for(i="",t=0;t<n.list.length;t++)i+="<tr data-record_id="+n.list[t].record_id+">",i+=isNullOrWhiteSpace(n.list[t].newp_barcode)?"<td>"+n.list[t].newp_barcode+"<\/td>":isNullOrWhiteSpace(n.list[t].origp_barcode)?"<td>"+n.list[t].origp_barcode+"<\/td>":"<td><\/td>",i+=isNullOrWhiteSpace(n.list[t].newp_name)?n.list[t].newp_name.length>11?'<td class="amountcolor2" title="'+n.list[t].newp_name+'">'+n.list[t].newp_name.substring(0,10)+"......<\/td>":'<td class="amountcolor2">'+n.list[t].newp_name+"<\/td>":n.list[t].origp_name&&n.list[t].origp_name.length>11?'<td class="amountcolor2" title="'+n.list[t].origp_name+'">'+n.list[t].origp_name.substring(0,10)+"......<\/td>":'<td class="amountcolor2">'+n.list[t].origp_name+"<\/td>",i+=isNullOrWhiteSpace(n.list[t].origp_barcode)?"<td>"+n.list[t].origp_barcode+"<\/td>":"<td><\/td>",i+=isNullOrWhiteSpace(n.list[t].origp_name)?n.list[t].origp_name.length>11?'<td title="'+n.list[t].origp_name+'">'+n.list[t].origp_name.substring(0,10)+".....<\/td>":"<td>"+n.list[t].origp_name+"<\/td>":"<td><\/td>",n.list[t].sv_pricing_method==1?(i+="<td>"+n.list[t].sv_transferweight+"<\/td>",i+="<td data-av_aupplyshop_id="+n.list[t].av_aupplyshop_id+">"+n.list[t].av_aupplyshop_name+"<\/td>",i+="<td>"+n.list[t].sv_aupplyshoptransfrontweight+"<\/td>",i+="<td>"+n.list[t].sv_aupplyshoptransfterweight+"<\/td>",i+="<td data-sv_targetshop_id="+n.list[t].sv_targetshop_id+">"+n.list[t].sv_targetshop_name+"<\/td>",i+="<td>"+n.list[t].sv_targetshopallotfrontweight+"<\/td>",i+="<td>"+n.list[t].sv_targetshopallotfterweight+"<\/td>"):(i+="<td>"+n.list[t].sv_transfernumber+"<\/td>",i+="<td data-av_aupplyshop_id="+n.list[t].av_aupplyshop_id+">"+n.list[t].av_aupplyshop_name+"<\/td>",i+="<td>"+n.list[t].sv_aupplyshoptransfrontnumber+"<\/td>",i+="<td>"+n.list[t].sv_aupplyshoptransfternumber+"<\/td>",i+="<td data-sv_targetshop_id="+n.list[t].sv_targetshop_id+">"+n.list[t].sv_targetshop_name+"<\/td>",i+="<td>"+n.list[t].sv_targetshopallotfrontnumber+"<\/td>",i+="<td>"+n.list[t].sv_targetshopallotfternumber+"<\/td>"),i+="<td>"+n.list[t].sv_employee_name+"<\/td>",i+="<td><span>"+new Date(n.list[t].sv_transferdate).Format("yyyy-MM-dd")+"<\/span><\/td>",i+=isNullOrWhiteSpace(n.list[t].sv_remarks)?'<td class="allocationDetails tipss" data-content="'+n.list[t].sv_remarks+'"><a href="javascript: void(0);" class="amountcolor2">\u8be6\u60c5<\/a><\/td>':'<td class="allocationDetails" data-content="'+n.list[t].sv_remarks+'"><\/td>',i+="<\/tr>";$("#allocationlist").html(i)}else $("#allocationlist").html('<tr><td class="text-center sad" style="" colspan="14"><img src="../skin_N3/images/sad.png" /><i class="padd0">\u6682\u65e0\u6570\u636e<\/i><\/td><\/tr>')})},operating:function(){function n(){$.get("/BranchStore/GetStorelist/?type=1&&StorePageState=4",function(n){var t,i;if(n==-2)layer.msg("\u60a8\u6ca1\u6709\u8be5\u6743\u9650\uff01");else if(t="",n==-1)$(".storeinfo").hide();else{$(".storeinfo").show();for(i in n)t+=n[i];$("#outStore,#intoStore").html(t)}})}n();$("#transfersBtn,#queryLikeBtn").click(function(){var n=$("#outStore").val(),t=$("#intoStore").val(),i=$("#startDate").val(),r=$("#endDate").val(),u=$("#query_like").val();transfer.getRecordsPage(n,t,u,i,r)});$("#query_like").keyup(function(){var n=$("#outStore").val(),t=$("#intoStore").val(),i=$("#startDate").val(),r=$("#endDate").val(),u=$("#query_like").val();transfer.getRecordsPage(n,t,u,i,r)});$("#begindate").datetimepicker({language:"zh",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0,endDate:new Date,pickerPosition:"bottom-left",format:"yyyy/mm/dd"}).on("change",function(){var n=$("#startDate").val();$("#enddate").datetimepicker("setStartDate",n)});$("#enddate").datetimepicker({language:"zh",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0,startDate:$("#startDate").val(),endDate:new Date,pickerPosition:"bottom-left",format:"yyyy/mm/dd"}).on("change",function(){var n=$("#endDate").val();$("#begindate").datetimepicker("setReturnDate",n)})}},addTransfer={openTransferPage:function(){function r(){$.get("/BranchStore/GetStorelist/?type=1&&StorePageState=4",function(n){var t,i;if(n==-2)layer.msg("\u60a8\u6ca1\u6709\u8be5\u6743\u9650\uff01");else if(t="",n!=-1){for(i in n)t+=n[i];$("#outStore2,#intoStore2").html(t)}})}function u(){var t=$.Deferred();$.get("/BranchStore/GetStorelist/?type=1&&StorePageState=4",function(n){var i,r;if(n==-2)layer.msg("\u60a8\u6ca1\u6709\u8be5\u6743\u9650\uff01");else if(i="",n!=-1){for(r in n)i+=n[r];$("#outStore3").html(i);t.resolve()}});t.then(function(){var t=$("#outStore3").val();n(t,"")})}function n(n,t){$.get("/StoreStockGoodsAllot/GetStockinfoCount/",{strstore:n,search:t},function(i){var r=Math.ceil(i/pageSize);laypage({cont:$("#pageGro2"),pages:r,skin:"molv",skip:!0,first:"\u9996\u9875",last:"\u5c3e\u9875",prev:"\u4e0a\u4e00\u9875",next:"\u4e0b\u4e00\u9875",jump:function(i){f(n,t,i.curr)}})});$("#layerclosethispage").val(layer.index)}function f(n,t,i){$.getJSON("/StoreStockGoodsAllot/GetStockinfolist/",{strstore:n,search:t,pageIndex:i,pageSize:pageSize},function(n){var i,t,f,r,u,e,o;if(n&&n.length>0)for(i="",$('.selectcheckbox[data-type="all"]').prop("checked",!1),t=0;t<n.length;t++)f=checkedProductId[n[t].product_id],r="",f!=undefined&&(r="checked"),u=n[t].sv_pricing_method==1?n[t].sv_p_total_weight:n[t].sv_p_storage,i+='<tr data-pid="'+n[t].product_id+'" data-pricingmethod="'+n[t].sv_pricing_method+'">',i+='<td><input data-sv_p_storage="'+u+'" data-pid="'+n[t].product_id+'" data-pricingmethod="'+n[t].sv_pricing_method+'" data-price = '+n[t].sv_p_originalprice+'  type="checkbox" '+r+' class="checkinput lucky selectcheckbox" name="single" value="'+n[t].product_id+'" style="display:block;width:16px;height:16px;padding-left:0;"/><\/td>',i+="<td>"+(n[t].sv_p_barcode==null?"":n[t].sv_p_barcode)+"<\/td> ",i+="<td><span>"+(n[t].sv_p_name==null?"":n[t].sv_p_name)+"<\/span>",i+='<input type="hidden" id="id_'+n[t].product_id+'" value="'+(n[t].sv_p_name==null?"":n[t].sv_p_name)+'" /><\/td>',i+='<td><i class="colorff">\u00a5'+parseFloat(n[t].sv_p_originalprice).toFixed(2)+"<\/i><\/td>",i+="<td>"+u+"<\/td><td>"+n[t].sv_p_unit+"<\/td> <\/a><\/tr>";$("#product_tbody").html(i);e=$('.selectcheckbox[name="single"]:checked').length;o=$(".selectcheckbox").length-1;e==o&&$('.selectcheckbox[data-type="all"]').prop("checked",!0)})}function i(n,i){var r="";for(var u in n)r+=n[u]+",";r=r.substr(0,r.length-1);$.getJson("/StoreStockGoodsAllot/GetStockinfolist/",{strstore:$("#outStore3").val()||$("#outStore2").val(),search:i,pageIndex:0,pageSize:0,productid:r},function(n){var i,u;if(n!=null&&n.length>0){var r="",f=n.length;for(i=0;i<n.length;i++)u=n[i].sv_pricing_method==1?n[i].sv_p_total_weight:n[i].sv_p_storage,r+='<tr data-pid="'+n[i].product_id+'" data-pricingmethod="'+n[i].sv_pricing_method+'">',r+="<td>"+n[i].sv_p_barcode+"<\/td>",r+='<td><input type="hidden" name="product_id" value="'+n[i].product_id+'"/>',r+='<input type="hidden"  id="sv_p_storage_'+n[i].product_id+'" value="'+Math.ceil(u)+'"/>',r+='<input type="hidden"  id="price'+n[i].product_id+'" value="'+parseFloat(n[i].sv_p_originalprice).toFixed(2)+'"/>',r+="<span>"+(n[i].sv_p_name==null?"":n[i].sv_p_name)+"<\/span><\/td>",r+="<td>"+(n[i].sv_pc_name||"")+"<\/td>",r+="<td>"+(n[i].sv_p_unit||"")+"<\/td>",r+="<td>"+u+"<\/td>",r+='<td><input type="text" data-pid="'+n[i].product_id+'" class="form-control selectpurchaselist" name="" id="count_'+n[i].product_id+'" value="1" placeholder="\u8f93\u5165\u6570\u91cf"/><\/td>',r+="<td>"+parseFloat(n[i].sv_p_originalprice).toFixed(2)+"<\/td>",r+='<td id="singletotal_'+n[i].product_id+'">'+parseFloat(n[i].sv_p_originalprice).toFixed(2)+"<\/td>",r+='<td><i data-product_id="'+n[i].product_id+'" class="icon-remove-sign deletepurchase"><\/i><\/td>',r+="<\/tr>";$("#transfersDetail").html(r);$("#totalMoney").text(0..toFixed(2));$("#totalCounts").text(f.toFixed(2));t()}else $("#transfersDetail").html("")})}function t(){var i=$("#transfersDetail tr"),n=0,t=0;$.each(i,function(){var i=$(this).data("pid"),r=parseFloat($(this).find("#count_"+i).val()||0),u=parseFloat($(this).find("#price"+i).val()||0);n+=r*u;t+=r});$("#totalMoney").text(n.toFixed(2));$("#totalCounts").text(t.toFixed(2))}function e(){var n=$("#outStore2").val(),t=$("#intoStore2").val(),i=$("#transfersDetail tr"),r=$("#sv_remarks").val();return i.map(function(){var i=$(this).data("pid"),u=parseFloat($(this).find("#count_"+i).val()||0);if(u<=0){$(this).find("#count_"+i).focus();layer.msg("\u8c03\u62e8\u7684\u6570\u91cf\u5fc5\u987b\u5927\u4e8e0");return}return{sv_transfernumber:u,product_id:$(this).data("pid"),sv_targetshop_id:t,av_aupplyshop_id:n,sv_remarks:r,sv_pricing_method:$(this).attr("data-pricingmethod")}}).get()}$(document).unbind("click","#addAllocation").on("click","#addAllocation",function(){checkedProductId={};layerpage.Deke_layerpage.show_Url2("1","\u65b0\u589e\u8c03\u62e8","/ajaxHtml_N3/stock/addAllocation.html?="+getTimeStamp(),["790px","520px"],r)});$(document).unbind("click",".selectAllocationlist-btn").on("click",".selectAllocationlist-btn",function(){layerpage.Deke_layerpage.show_Url2("1","\u9009\u62e9\u5546\u54c1","/ajaxHtml_N3/stock/selectProductList.html?="+getTimeStamp(),["790px","520px"],u)});$(document).unbind("click","#outStore3").on("click","#outStore3",function(){var t=$("#outStore3").val();n(t,"")});$(document).unbind("click","#queryLikeBtn2").on("click","#queryLikeBtn2",function(){var t=$("#query_productinfo").val().trim(),i=$("#outStore3").val();n(i,t)});$(document).on("keyup","#query_productinfo",function(){var t=$("#query_productinfo").val().trim(),i=$("#outStore3").val();n(i,t)});$(document).unbind("click",".selectcheckbox").on("click",".selectcheckbox",function(){var o=$(this).attr("data-type"),i,r,u,n,t,f,e;o=="all"?(i=$(this).is(":checked"),i?($("#product_tbody").find('.selectcheckbox[name="single"]').prop("checked",!0),$('#product_tbody .selectcheckbox[name="single"]').each(function(){var n=$(this).data("pid"),t=$(this).data("sv_p_storage");t==0&&(zeroStockProductObject[n]=$("#id_"+n).val());checkedProductId[n]=n})):($("#product_tbody").find('.selectcheckbox[name="single"]').prop("checked",!1),$('#product_tbody .selectcheckbox[name="single"]').each(function(){var n=$(this).data("pid"),t=$(this).data("sv_p_storage");t==0&&delete zeroStockProductObject[n];delete checkedProductId[n]}))):(r=$(this).is(":checked"),u=$('.selectcheckbox[data-type="all"]').is(":checked"),r?(n=$(this).data("pid"),t=$(this).data("sv_p_storage"),t==0&&(zeroStockProductObject[n]=$("#id_"+n).val()),checkedProductId[n]=n):(n=$(this).data("pid"),t=$(this).data("sv_p_storage"),t==0&&delete zeroStockProductObject[n],delete checkedProductId[n]),u?$('.selectcheckbox[data-type="all"]').prop("checked",!1):(f=$('.selectcheckbox[name="single"]:checked').length,e=$(".selectcheckbox").length-1,f==e&&$('.selectcheckbox[data-type="all"]').prop("checked",!0)));$("#checkedCounts").text(Object.keys(checkedProductId).length)});$(document).unbind("click","#determineAllocation").on("click","#determineAllocation",function(){var r=Object.keys(checkedProductId),n=Object.keys(zeroStockProductObject),t,u;if(n.length>0){t=[];for(u in zeroStockProductObject)t.push(zeroStockProductObject[u]);layer.msg("\u300a"+t+"\u300b"+n.length+"\u4e2a\u5546\u54c1\u5e93\u5b58\u4e3a0\uff0c\u4e0d\u80fd\u6267\u884c\u8c03\u62e8\u64cd\u4f5c\uff01")}r.length>0&&n.length==0?(i(r),layer.close($("#layerclosethispage").val())):layer.msg("\u81f3\u5c11\u9009\u62e91\u4e2a\u8c03\u62e8\u7684\u5546\u54c1\uff01")});$(document).on("keypress","#selectpurchaselist_like",function(n){n.keyCode==13&&i("",$(this).val())});$(document).unbind("click","#transfersDetail .deletepurchase").on("click","#transfersDetail .deletepurchase",function(){var n=$(this).data("product_id");delete checkedProductId[n];$("#transfersDetail").find('tr[data-pid="'+n+'"]').remove();t()});$(document).unbind("keyup","#transfersDetail .selectpurchaselist").on("keyup","#transfersDetail .selectpurchaselist",function(){shareClearNoNum(this);var n=$(this).data("pid"),i=parseFloat($(this).val()),r=parseFloat($("#sv_p_storage_"+n).val()),u=$("#price"+n).val();i>r?($(this).val(r),layer.msg("\u8f93\u5165\u7684\u5e93\u5b58\u6570\u91cf\u8d85\u8fc7\u4e86\u6539\u5546\u54c1\u7684\u6700\u5927\u5e93\u5b58\u503c\uff01")):i==0&&$(this).val(1);$("#singletotal_"+n).text(parseFloat(u*i||0).toFixed(2));t()});$(document).unbind("click","#determineAllocationBtn").on("click","#determineAllocationBtn",function(){var i=$("#outStore2").val(),n=$("#intoStore2").val(),t=$("#transfersDetail tr");t.length>0?$.getJSON("/BranchStore/GetStoreRelation/",{IntoStore:n,OutStore:i},function(i){if(i!=null)if(i.av_shopstate==1&&i.sv_deliveryway>0)if(i.sv_deliveryway==1||i.sv_deliveryway==2&&i.sv_subbranch_id==n){var r=e();r.length==t.length&&layer.confirm("\u60a8\u786e\u8ba4\u8981\u628a\u300a"+$("#outStore2 option:selected").text()+"\u300b\u5e97\u94fa\u5e93\u5b58\u8c03\u62e8\u5230\u300a"+$("#intoStore2 option:selected").text()+"\u300b\u5e97\u94fa\u5e93\u5b58\u53bb\u5417\uff1f",{btn:["\u786e\u8ba4\u8c03\u62e8","\u5173\u95ed"]},function(){$.ajax({url:"/StoreStockGoodsAllot/SaveStoreStockLotted",type:"post",contentType:"application/json",data:JSON.stringify(r),async:!1,success:function(n){n.succeed==!0?(layer.closeAll(),layer.msg(n.values),transfer.getRecordsPage("","","","","")):n==-2?layer.msg("\u4f60\u6ca1\u6709\u8be5\u64cd\u4f5c\u6743\u9650\uff01"):layer.msg(n.values||"\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u5728\u64cd\u4f5c\uff01")}})})}else layer.msg("\u300a"+$("#outStore2 option:selected").text()+"\u300b\u5e97\u94fa \n \u4e0e\u300a"+$("#intoStore2 option:selected").text()+"\u300b\u5e97\u94fa\u7684\u8c03\u62e8\u65b9\u5f0f\u4e3a\uff1a\u300a"+i.sv_deliverywayName+"\u300b");else layer.msg("\u8bf7\u5148\u8bbe\u7f6e\u5206\u5e97\u5e97\u94fa\u72b6\u6001\uff0c\u4ee5\u53ca\u8c03\u62e8\u65b9\u6cd5");else layer.msg("\u300a"+$("#outStore2 option:selected").text()+"\u300b\u5e97\u94fa \n \u4e0e\u300a"+$("#intoStore2 option:selected").text()+"\u300b\u5e97\u94fa\u662f\u540c\u4e00\u7ea7\u5173\u7cfb\u5e97\u94fa,\u4e0d\u80fd\u6267\u884c\u8c03\u62e8\u64cd\u4f5c!")}):layer.msg("\u8bf7\u9009\u62e9\u8981\u8c03\u62e8\u7684\u5546\u54c1\u5728\u6267\u884c\u786e\u5b9a\u8c03\u62e8\u64cd\u4f5c\uff01")})}};