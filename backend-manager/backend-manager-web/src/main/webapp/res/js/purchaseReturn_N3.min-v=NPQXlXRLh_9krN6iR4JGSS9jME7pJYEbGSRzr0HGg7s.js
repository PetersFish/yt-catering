$(document).ready(function(){purchaseReturn.getPurchasePage("","","","","");purchaseReturn.operating();purchaseReturn.addNewPurchaseReturn()});var pageSize=15,purchaseReturn={getPurchasePage:function(n,t,i,r,u){$.get("/supplier/get_returnprocurementcount/?dahaono="+t+"&key="+n+"&prcode="+i+"&ghuoshan="+r+"&pcname="+u,function(f){var e=Math.ceil(f/5);$("#countslength").text(f);laypage({cont:"pageGro",pages:e,skin:"molv",skip:!0,first:"\u9996\u9875",last:"\u5c3e\u9875",prev:"\u4e0a\u4e00\u9875",next:"\u4e0b\u4e00\u9875",jump:function(f){purchaseReturn.getgetPurchaseList(f.curr,n,t,i,r,u)}})})},getgetPurchaseList:function(n,t,i,r,u,f){$.getJSON("/supplier/get_returnprocurement?page="+n+"&dahaono="+i+"&key="+t+"&prcode="+r+"&ghuoshan="+u+"&pcname="+f,function(n){var i,t,o,r,s,u,f,e,h;if(n&&n.length>0){for(i="",t=0;t<n.length;t++)if(o=new Date(n[t].sv_pc_date).Format("yyyy-MM-dd"),n[t].Prlist=n[t].prlist,n[t].Prlist.length==1)i+='<tr data-id="'+n[t].sv_pc_noid+'">',i+="<td>"+n[t].sv_pc_noid+"<\/td>",i+=isNullOrWhiteSpace(n[t].sv_suname)?'<td class="amountcolor2">'+n[t].sv_suname+"<\/td>":'<td class="amountcolor2"><\/td>',i+=isNullOrWhiteSpace(n[t].Prlist[0].sv_p_name)?"<td>"+n[t].Prlist[0].sv_p_name+"<\/td>":"<td><\/td>",i+="<td><span>"+n[t].Prlist[0].sv_p_barcode+"<\/span><\/td>",f=n[t].Prlist[0].sv_pricing_method==1?n[t].Prlist[0].sv_p_weight:n[t].Prlist[0].sv_pc_pnumber,i+="<td><span>"+f+"<\/span><\/td>",e=n[t].Prlist[0].sv_p_unit!=null&&n[t].Prlist[0].sv_p_unit!=""?n[t].Prlist[0].sv_p_unit:"",i+='<td class="minhide"><span>'+e+"<\/span><\/td>",i+='<td class="colorff">\u00a5'+parseFloat(n[t].Prlist[0].sv_pc_combined).toFixed(2)+"<\/td>",i+='<td class="minhide"><span>'+o+"<\/span><\/td>",i+='<td class="purchaseRetuenDetails" data-id="'+n[t].sv_pc_noid+'">',i+='<a href="javascript: void(0);" data-purchase_id="'+n[t].sv_pc_noid+'" class="amountcolor2">\u8be6\u60c5<\/a>',i+="<\/td>",i+=" <\/tr>";else{for(r="",s=0,u=0;u<n[t].Prlist.length;u++)r+='<tr class="hideproduct bordertopnone gesture" data-id= "'+n[t].sv_pc_noid+'">',r+="<td><\/td>",r+="<td><\/td>",r+="<td><span>"+n[t].Prlist[u].sv_p_name+"<\/span><\/td>",r+="<td><span>"+n[t].Prlist[u].sv_p_barcode+"<\/span><\/td>",f=n[t].Prlist[u].sv_pricing_method==1?n[t].Prlist[u].sv_p_weight:n[t].Prlist[u].sv_pc_pnumber,r+="<td><span>"+f+"<\/span><\/td>",e=n[t].Prlist[u].sv_p_unit!=null&&n[t].Prlist[u].sv_p_unit!=""?n[t].Prlist[u].sv_p_unit:" ",r+='<td class="minhide"><span>'+e+"<\/span><\/td>",r+='<td class="colorff">\u00a5'+parseFloat(n[t].Prlist[u].sv_pc_combined).toFixed(2)+"<\/td>",r+='<td class="minhide"><\/td>',r+="<td><\/td>",r+="<\/tr>",s+=f;i+='<tr class="moreProudct gesture" data-id="'+n[t].sv_pc_noid+'">';i+='<td class="gesture">'+n[t].sv_pc_noid+"<\/td>";i+=isNullOrWhiteSpace(n[t].sv_suname)?'<td class="amountcolor2">'+n[t].sv_suname+"<\/td>":'<td class="amountcolor2"><\/td>';n!=null&&n.length>t&&n[t].Prlist!=null&&n[t].Prlist.length>0&&n[t].Prlist[0]!=null&&n[t].Prlist[0].sv_p_name!=null?(i+='<td class="moretext">',i+='<div class="needdisplaynone fl colorff">\u672c\u6b21\u91c7\u8d2d\u9000\u8d27\u5546\u54c1:<span class="morepurchase multiplepen">\u591a\u4e2a<i class="icon-chevron-down male5 moreproduct" style="color:white;"><\/i><\/span><\/div>',i+='<div class="needdisplaynone2 fl">'+n[t].Prlist[0].sv_p_name+'<span class="morepurchase multiplepen">\u591a\u4e2a<\/span><\/div>',i+="<\/td>"):i+='<td><div class="needdisplaynone2 fl"><span class="morepurchase multiplepen">\u672c\u6b21\u91c7\u8d2d\u5df2\u9000\u5b8c<\/span><\/div><\/td>';i+=n!=null&&n.length>t&&n[t].Prlist!=null&&n[t].Prlist.length>0&&n[t].Prlist[0]!=null&&n[t].Prlist[0].sv_p_barcode!=null?'<td><span class="needdisplaynone2">'+n[t].Prlist[0].sv_p_barcode+'<\/span><span class="needdisplaynone"><\/span><\/td>':"<td><\/td>";f="";n!=null&&n.length>t&&n[t].Prlist!=null&&n[t].Prlist.length>0&&n[t].Prlist[0]!=null&&(f=n[t].Prlist[0].sv_pricing_method==1?n[t].Prlist[0].sv_p_weight:n[t].Prlist[0].sv_pc_pnumber);i+='<td><span class="needdisplaynone2">'+f+"<\/span><\/td>";e="";n!=null&&n.length>t&&n[t].Prlist!=null&&n[t].Prlist.length>0&&n[t].Prlist[0]!=null&&(e=n[t].Prlist[0].sv_p_unit!=null&&n[t].Prlist[0].sv_p_unit!=""?n[t].Prlist[0].sv_p_unit:"");i+='<td class="minhide"><span class="needdisplaynone2">'+e+"<\/span><\/td>";i+=n!=null&&n.length>t&&n[t].Prlist!=null&&n[t].Prlist.length>0&&n[t].Prlist[0]!=null&&n[t].Prlist[0].sv_pc_combined!=null?'<td class="colorff"><span class="needdisplaynone2">\u00a5'+parseFloat(n[t].Prlist[0].sv_pc_combined).toFixed(2)+"<span><\/td>":'<td class=""><span class="needdisplaynone2 colorff">\u00a50.00<\/span><\/td>';i+='<td class="minhide">'+o+"<\/td>";i+='<td class="purchaseRetuenDetails" data-id="'+n[t].sv_pc_noid+'">';i+='<a href="javascript: void(0);" data-purchase_id="'+n[t].sv_pc_noid+'" class="amountcolor2">\u8be6\u60c5<\/a>';i+="<\/td>";i+="<\/tr>";i+=r}$("#productreturnlist").html(i)}else h=$("#rowlength").children("th").length,$("#productreturnlist").html('<tr><td class="text-center sad" style="text-align:center !important;" colspan="'+h+'"><img src="../skin_N3/images/sad.png" /><i class="padd0">\u6682\u65e0\u91c7\u8d2d\u9000\u8d27\u6570\u636e<\/i><\/td><\/tr>')})},operating:function(){$(document).unbind("click",".moreProudct>td:nth-child(3)").on("click",".moreProudct>td:nth-child(3)",function(){var n=$(this).parent().attr("data-id");$(this).parent().hasClass("open")?($(this).parent().removeClass("open"),$(this).parent().find(".needdisplaynone").hide(0),$(this).parent().find(".needdisplaynone2").show(0),$('.hideproduct[data-id="'+n+'"]').css("display","none")):($(this).parent().addClass("open"),$(this).parent().find(".needdisplaynone2").hide(0),$(this).parent().find(".needdisplaynone").show(0),$('.hideproduct[data-id="'+n+'"]').css("display","table-row"))});$(document).on("click",".searchpurchase-btn",function(){$(this).hasClass("active")?($(".searchProductReturnlist").slideDown(300),$(this).removeClass("active"),$(this).html("\u6536\u8d77\u641c\u7d22")):($(".searchProductReturnlist").slideUp(300),$(this).addClass("active"),$(this).html("\u9ad8\u7ea7\u641c\u7d22"))});$("#query_purchase_return_btn").click(function(){var n=$("#dahaono").val().trim(),t=$("#prcode").val().trim(),i=$("#ghuoshan").val().trim(),r=$("#pcname").val().trim();purchaseReturn.getPurchasePage("",n,t,i,r)});$("#reset_purchase_return_btn").click(function(){$("#dahaono,#prcode,#ghuoshan,#pcname").val("")})},addNewPurchaseReturn:function(){function r(){$.getJSON("/supplier/supplierlist?id=-1&key=",function(n){if(n&&n.length>0)for(var t=0;t<n.length;t++)$("#sv_suid").append('<option value="'+n[t].sv_suid+'">'+n[t].sv_suname+"<\/option>")}).done(function(){$.get("/WarehouseInfo/GetWarehouse",function(n){var t,i;if(n!=null&&n!=""){t="";is_exist_warehouse=!0;for(i in n)t+=n[i];$("#sv_orgwarehouse_id").html(t)}});$("#numbier").text("DECS"+(new Date).Format("yyyyMMddhhmmssS"));$("#sv_pc_date").val((new Date).Format("yyyy-MM-dd hh:mm:ss"))})}function n(n,t){var i=15;$.get("/supplier/get_procurementcount",{date:n,key:t},function(r){var f=Math.ceil(r/i);laypage({cont:"pageGro2",pages:f,skin:"molv",skip:!0,first:"\u9996\u9875",last:"\u5c3e\u9875",prev:"\u4e0a\u4e00\u9875",next:"\u4e0b\u4e00\u9875",jump:function(r){u(r.curr,i,n,t)}})})}function u(n,t,i,r){$.get("/supplier/get_procurement",{page:n,top:t,date:i,key:r},function(n){var t,i,r;if(n&&n.length>0){for(t="",i=0;i<n.length;i++)n[i].sv_pc_state==1&&(daye=new Date(n[i].sv_pc_date).Format("yyyy-MM-dd hh:mm:ss"),t+="<tr>",t+="<td><span>"+n[i].sv_pc_noid+"<\/span><\/td>",t+="<td><span>"+n[i].sv_suname+"<\/span><\/td>",t+="<td><i>\u00a5"+n[i].sv_pc_combined+"<\/i><\/td>",t+="<td><i>\u00a5"+n[i].sv_pc_realpay+"<\/i><\/td>",t+='<td><span class="colorff">'+f(n[i].sv_pc_state)+"<\/span><\/td>",t+="<td><span>"+daye+"<\/span><\/td>",t+='<td class="changeproduct3"><button class="serviceProductSelect btn editproductinfo" type="button" data-id="'+n[i].sv_pc_noid+'">\u9009\u62e9<\/button><\/td>',t+="<\/tr>");$("#selectPurchaseList").html(t)}else r=$("#rowlength").children("th").length,$("#selectPurchaseList").html('<tr><td class="text-center sad" style="text-align:center !important;" colspan="7"><img src="../skin_N3/images/sad.png" /><i class="padd0">\u6682\u65e0\u6570\u636e<\/i><\/td><\/tr>')});selectPurcharesDateReminderTime("query_purchase_order_date")}function f(n){switch(n){case 0:return"\u5f85\u5165\u5e93";case 2:return"\u53d6\u6d88";case 1:return"\u5df2\u5165\u5e93"}}function i(n,i){$("#selectproduct").empty();$.get("/supplier/GetprocUrementoDall?nober="+n,function(n){var i,r,u;if(loggin.chklogn(n),$("#sv_suid").val(n.sv_suid),$("#sv_orgwarehouse_id").attr("disabled","disabled"),$("#sv_orgwarehouse_id").val(n.sv_targetwarehouse_id),$("#sv_orgwarehouse_id").val()!=""?$("._sv_targetwarehouse_id").hide():$("._sv_targetwarehouse_id").show(),$("#sv_pc_date").val(new Date(n.sv_pc_date).Format("yyyy-MM-dd hh:mm:ss")),$("#sv_pc_noid").val(n.sv_pc_noid),n.prlist&&n.prlist.length>0){for(i="",n.Prlist=n.prlist,r=0;r<n.Prlist.length;r++)u=n.Prlist[r].sv_pricing_method==1?n.Prlist[r].sv_p_weight:n.Prlist[r].sv_pc_pnumber,i+='<tr data-sv_pc_productid="'+n.sv_pc_noid+'" data-pricingmethod="'+n.Prlist[r].sv_pricing_method+'" data-pid="'+n.Prlist[r].product_id+'" data-sv_pc_pnumber="'+u+'">',i+="<td>"+n.Prlist[r].sv_p_barcode+"<\/td>",i+="<td>"+n.Prlist[r].sv_p_name+"<\/td>",i+="<td>"+n.Prlist[r].sv_p_unit+"<\/td>",i+="<td>"+u+"<\/td>",i+="<td>",i+='<input type="text" class="form-control selectpurchaselist" name="" data-pid="'+n.Prlist[r].product_id+'" id="number_'+n.Prlist[r].product_id+'" value="'+u+'" placeholder="\u8f93\u5165\u6570\u91cf"/>',i+='<input type="hidden" class="form-control selectpurchaselist" name="" id="sv_p_storage_'+n.Prlist[r].product_id+'" value="'+u+'" placeholder=""/>',i+="<\/td>",i+="<td>",i+='<input type="text" class="form-control selectpurchaselist" name="" id="price_'+n.Prlist[r].product_id+'" value="'+n.Prlist[r].sv_pc_price+'" readonly="" placeholder=""/>',i+="<\/td>",i+="<td>",i+='<input type="text" class="form-control selectpurchaselist" name="" id="allPrice_'+n.Prlist[r].product_id+'" value="'+n.Prlist[r].sv_pc_combined+'" readonly="" placeholder=""/>',i+="<\/td>",i+="<td>",i+='<i data-pid="'+n.Prlist[r].product_id+'" class="icon-remove-sign deletepurchase"><\/i>',i+="<\/td><\/tr>";$("#selectproduct").html(i);t()}});i=="close"&&layer.close(layer.index)}function t(){var i=$("#selectproduct tr"),n=0,t=parseFloat($("#qitafeiyong").val()||0);$.each(i,function(){var t=$(this).data("pid"),i=parseFloat($("#allPrice_"+t).val());n+=i});$("#orderTotalAmount").text(n.toFixed(2));$("#allTotalAmount").text((n+t).toFixed(2));$("#allTotalAmountValue").val((n+t).toFixed(2))}function e(n){$.get("/supplier/GetreturnprocUrementoDall?nober="+n,function(n){var i,r,t,u;loggin.chklogn(n);$("#stockorderinout").html('<a class="fl" href="javascript:void(0)" data-action="GetprocUrementoDall" data-id="'+n.sv_associated_code+'"><i>'+n.sv_associated_code+'<\/i><i class="paleft10">(\u8fdb\u8d27\u5355\u53f7)<\/i><\/a><a class="fl active" data-action="GetreturnprocUrementoDall" class="active" data-id="'+n.sv_pc_noid+'"  href="javascript:void(0)"><i>'+n.sv_pc_noid+'<\/i><i class="paleft10">(\u9000\u8d27\u5355\u53f7)<\/i><\/a>');for(i in n)i=="sv_pc_date"?$("#"+i).text(new Date(n[i]).Format("yyyy-MM-dd hh:mm:ss")):$("#"+i).text(n[i]);for(n.Prlist||(n.Prlist=n.prlist),r="",t=0;t<n.Prlist.length;t++)u=n.Prlist[t].sv_pricing_method==1?n.Prlist[t].sv_p_weight:n.Prlist[t].sv_pc_pnumber,r+="<tr> <td><span>"+(t+1)+"<\/span><\/td><td class='amountcolor2'><span>"+n.Prlist[t].sv_p_barcode+"<\/span><\/td> <td><span>"+n.Prlist[t].sv_p_name+"<\/span><\/td> <td><span>"+n.Prlist[t].sv_p_unit+"<\/span><\/td> <td><span>"+u+"<\/span><\/td><td><i>\u00a5"+n.Prlist[t].sv_pc_price+"<\/i><\/td> <td class='colorff'><i>\u00a5"+n.Prlist[t].sv_pc_combined+"<\/i><\/td> <\/tr>";$("#sholist").html(r)})}function o(n,t){$.get("/supplier/"+t+"?nober="+n,function(n){var i,r,t,u;if(n==-2)layer.msg("\u4f60\u6ca1\u6709\u8be5\u64cd\u4f5c\u6743\u9650"),layer.close(index);else{for(i in n)i=="sv_pc_date"?$("#"+i).text(new Date(n[i]).Format("yyyy-MM-dd hh:mm:ss")):$("#"+i).text(n[i]);for(n.Prlist||(n.Prlist=n.prlist),r="",t=0;t<n.Prlist.length;t++)u=n.Prlist[t].sv_pricing_method==1?n.Prlist[t].sv_p_weight:n.Prlist[t].sv_pc_pnumber,r+="<tr> <td><span>"+(t+1)+"<\/span><\/td><td class='amountcolor2'><span>"+n.Prlist[t].sv_p_barcode+"<\/span><\/td> <td><span>"+n.Prlist[t].sv_p_name+"<\/span><\/td> <td><span>"+n.Prlist[t].sv_p_unit+"<\/span><\/td> <td><span>"+u+"<\/span><\/td><td><i>\u00a5"+n.Prlist[t].sv_pc_price+"<\/i><\/td> <td class='colorff'><i>\u00a5"+n.Prlist[t].sv_pc_combined+"<\/i><\/td> <\/tr>";$("#sholist").html(r)}})}$(document).unbind("click","#addproductreturn").on("click","#addproductreturn",function(){layerpage.Deke_layerpage.show_Url2("1","\u65b0\u589e\u9000\u8d27","/ajaxHtml_N3/stock/addproductretuen.html?="+getTimeStamp(),["790px","520px"],r())});$(document).unbind("click","#slesctpurchaselist").on("click","#slesctpurchaselist",function(){layerpage.Deke_layerpage.show_Url2("1","\u91c7\u8d2d\u6e05\u5355","/ajaxHtml_N3/stock/slesctpurchaselist.html?="+getTimeStamp(),["790px","520px"],n)});$(document).unbind("click","#query_purchase_order_btn").on("click","#query_purchase_order_btn",function(){var t=$("#query_purchase_order_like").val(),i=$("#query_purchase_order_date").val();n(i,t)});$(document).unbind("change","#query_purchase_order_date").on("change","#query_purchase_order_date",function(){var t=$("#query_purchase_order_like").val(),i=$(this).val();n(i,t)});$(document).unbind("click","#query_purchase_order_resule").on("click","#query_purchase_order_resule",function(){var i=$("#query_purchase_order_date").val(""),t=$("#query_purchase_order_like").val();n("",t)});$(document).unbind("click","#selectPurchaseList .serviceProductSelect").on("click","#selectPurchaseList .serviceProductSelect",function(){var n=$(this).data("id");i(n,"close")});$(document).unbind("keyup","#selectproduct .selectpurchaselist").on("keyup","#selectproduct .selectpurchaselist",function(){shareClearNoNum(this);var n=$(this).data("pid"),i=parseFloat($(this).val()),r=parseFloat($("#sv_p_storage_"+n).val()),u=$("#price_"+n).val();i>r&&($(this).val(r),layer.msg("\u8f93\u5165\u7684\u5e93\u5b58\u6570\u91cf\u8d85\u8fc7\u4e86\u6539\u5546\u54c1\u7684\u6700\u5927\u5e93\u5b58\u503c\uff01"));$("#allPrice_"+n).val(parseFloat(u*i||0).toFixed(2));t()});$(document).on("keyup","#qitafeiyong",function(){shareClearNoNum(this);t()});$(document).on("keypress","#sv_pc_noid",function(n){n.keyCode==13&&i($(this).val(),"open")});$(document).unbind("click","#selectproduct .deletepurchase").on("click","#selectproduct .deletepurchase",function(){var n=$(this).data("pid");$("#selectproduct").find('tr[data-pid="'+n+'"]').remove();t()});$(document).unbind("click","#confirmPurchaseReturnBtn").on("click","#confirmPurchaseReturnBtn",function(){var t=$("#selectproduct tr"),n=!0,i="",r,u;if(t.length<1){layer.msg("\u6ca1\u6709\u4efb\u4f55\u53ef\u9000\u7684\u7269\u54c1\uff01");return}r=t.map(function(){var t=$(this).data("pid"),r=$("#number_"+t).val(),u=$(this).find("td").eq(1).text()+","+$(this).find("td").eq(0).text()+",",f=$(this).data("#sv_pc_pnumber"),e=$("#price_"+t).val(),o=$("#allPrice_"+t).val(),s=$(this).data("pricingmethod");if(r<1){layer.msg(u+"\u9000\u8d27\u6570\u5fc5\u987b\u586b\u5199\u5927\u4e8e\u96f6");n=!1;return}if(f<r){layer.msg(u+"\u6700\u591a\u53ef\u9000\u3010"+f+"\u3011");n=!1;return}return i+=u,{product_id:t,sv_pc_pnumber:r,sv_pc_price:e,sv_pc_combined:o,sv_pricing_method:s}}).get();u={sv_pc_noid:$("#numbier").text(),sv_orgwarehouse_id:-1||$("#sv_orgwarehouse_id").val(),sv_pc_Operation:$("#sv_pc_Operation").val(),sv_suid:$("#sv_suid").val(),sv_pc_date:$("#sv_pc_date").val(),sv_pc_note:$("#sv_pc_note").val(),sv_pc_combined:$("#orderTotalAmount").text(),sv_pc_total:$("#allTotalAmount").text(),sv_pc_costs:$("#qitafeiyong").val(),sv_pc_settlement:$("#sv_pc_settlement").val(),sv_pc_state:1,sv_pc_realpay:$("#allTotalAmountValue").val(),sv_productname:i,sv_associated_code:$("#sv_pc_noid").val(),Prlist:r};n&&(enabledButtonById("confirmPurchaseReturnBtn"),$.ajax({url:"/supplier/addsv_purchasereturn",type:"post",data:JSON.stringify(u),contentType:"application/json",async:!1,success:function(n){loggin.chklogn(n);n>0?(layer.closeAll(),layer.msg("\u9000\u8d27\u5355\u521b\u5efa\u6210\u529f\uff01"),purchaseReturn.getPurchasePage("","","","","")):n==-3?layer.msg("\u5176\u4e2d\u6709\u4ea7\u54c1\u5df2\u7ecf\u5931\u6548\uff01"):n==-6?layer.msg("\u4ed3\u5e93\u4e0d\u5b58\u5728\uff01"):n==-4?layer.msg("\u5f53\u524d\u4ed3\u5e93\u4e0d\u5b58\u5728\u8be5\u5546\u54c1\uff01"):(layer.msg("\u9000\u8d27\u5931\u8d25\uff0c\u6709\u4ea7\u54c1\u5e93\u5b58\u4e0d\u8db3\uff01"),layer.close(index));enabledButtonById("confirmPurchaseReturnBtn")}}))});$(document).unbind("click","#productreturnlist .purchaseRetuenDetails").on("click","#productreturnlist .purchaseRetuenDetails",function(){var n=$(this).data("id");layerpage.Deke_layerpage.show_Url2("1","\u91c7\u8d2d\u9000\u8d27\u6e05\u5355","/ajaxHtml_N3/stock/purchaseReturnDetails.html?="+getTimeStamp(),["790px","520px"],e(n))});$(document).unbind("click","#stockorderinout>a").on("click","#stockorderinout>a",function(){$(this).addClass("active").siblings("a").removeClass("active");var n=$(this).data("id"),t=$(this).data("action");o(n,t)})}};